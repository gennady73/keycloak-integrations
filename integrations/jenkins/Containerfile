# Use a recent official Jenkins LTS image
FROM jenkins/jenkins:2.452.3-jdk17

# Define a build-time argument for the keystore password
ARG KEYSTORE_PASSWORD

# Switch to root user to install plugins
USER root

# Copy the Java keystore into Jenkins home
COPY ./server.jks /var/jenkins_ssl/

# Optional: Set permissions (not always needed, but safe to do)
RUN chown jenkins:jenkins /var/jenkins_ssl/server.jks

# Copy the lab's root CA certificate into the container
COPY ./ca.crt /tmp/root-ca.crt
RUN keytool -importcert -keystore ${JAVA_HOME}/lib/security/cacerts \
    -storepass changeit -noprompt -alias lab-root-ca -file /tmp/root-ca.crt

# Install the Keycloak Authentication plugin
EXPOSE 8080
EXPOSE 8443
EXPOSE 50000

# Set the JENKINS_OPTS environment variable using the build-time argument
# IMPORTANT: The default value is empty to prevent accidental exposure
ENV JENKINS_OPTS="--httpPort=-1 --httpsPort=8443 --httpsKeyStore=/var/jenkins_ssl/server.jks --httpsKeyStorePassword=${KEYSTORE_PASSWORD}"

# Switch back to jenkins user
USER jenkins
